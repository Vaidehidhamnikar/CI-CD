name: Calculator App CI/CD to Snowflake

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set Version Tag
        id: vars
        run: |
          VERSION_TAG="v${GITHUB_RUN_NUMBER}"
          echo "VERSION_TAG=$VERSION_TAG" >> $GITHUB_ENV
          echo "IMAGE_NAME=calculator-app" >> $GITHUB_ENV

      - name: Build Docker Image
        run: |
          echo "Building image: $IMAGE_NAME:$VERSION_TAG"
          docker build --platform=linux/amd64 -t $IMAGE_NAME:$VERSION_TAG .

      - name: Docker Login to Snowflake
        run: |
          echo "${{ secrets.SNOWFLAKE_DOCKER_PASSWORD }}" | \
          docker login ubhovfa-kasmo-inc.registry.snowflakecomputing.com \
          -u "${{ secrets.SNOWFLAKE_DOCKER_USERNAME }}" --password-stdin

      - name: Tag and Push Docker Image
        run: |
          REGISTRY="ubhovfa-kasmo-inc.registry.snowflakecomputing.com"
          DB="DASH_DB"                  # your Snowflake database
          SCHEMA="DASH_SCHEMA"          # your Snowflake schema
          STAGE="IMAGE_REPO_TEST"       # your Snowflake stage
          FULL_TAG="$REGISTRY/$DB/$SCHEMA/$STAGE/$IMAGE_NAME:$VERSION_TAG"

          echo "Tagging image: $FULL_TAG"
          docker tag $IMAGE_NAME:$VERSION_TAG $FULL_TAG
          echo "Pushing image: $FULL_TAG"
          docker push $FULL_TAG
